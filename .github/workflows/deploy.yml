name: CI

on:
  push:
    branches:
      - master_disabled
      - release

jobs:
  build:
    name: deploy
    runs-on: ubuntu-latest
    env:
      APP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.K8S_CREDENTIALS }}
    steps:
      - uses: actions/checkout@v1
      - name: Build API component
        run: |
          docker build -t docker.pkg.github.com/equinor/radix-example-arm-template/api:${GITHUB_REF##*/}-latest ./todoapi/
      - name: Push the image to GPR
        run: |
          echo ${{ secrets.PRIVATE_TOKEN }} | docker login docker.pkg.github.com -u JoakimHagen --password-stdin
          docker push docker.pkg.github.com/equinor/radix-example-arm-template/api:${GITHUB_REF##*/}-latest
      - name: Prepare for committing new tag to radix config on master
        uses: actions/checkout@v2-beta
        with:
          ref: master
      - name: Modify radixconfig tag for branch and commit
        env:
          SHA8: ${GITHUB_SHA::8}
        run: |
          BRANCH=${GITHUB_REF##*/} SHA=$SHA8 GITHUB_USER="ingeknudsen" GITHUB_EMAIL="ingeknudsen@users.noreply.github.com" GITHUB_REPO="${{ github.repository }}" PERSONAL_ACCESS_TOKEN=${{ secrets.PRIVATE_TOKEN }} ./hack/modify_tag_for_prod.sh
      - uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Get environment from branch
        id: getEnvironment
        uses: equinor/radix-github-actions@master
        with:
          args: >
            get-config branch-environment
            -b ${GITHUB_REF##*/}
      - name: Deploy API on Radix
        uses: equinor/radix-github-actions@master
        with:
          args: >
            trigger
            deploy
            --context development
            -e ${{ steps.getEnvironment.outputs.result }}
            -f
      - name: Get instrumentation key and connection string
        id: getSecrets
        run: |
          RESOURCE_GROUP=db-api-radix-${{ steps.getEnvironment.outputs.result }}
          INSTRUMENTATIONKEY=$(az group deployment show -g ${RESOURCE_GROUP} -n azuredeploy --query properties.outputs.appInsightInstrumentationKey.value)
          CONNECTION_STRING=$(az group deployment show -g ${RESOURCE_GROUP} -n azuredeploy --query properties.outputs.storageConnectionString.value)

          echo ::set-output name=instrumentationKey::$(echo ${INSTRUMENTATIONKEY})
          echo ::set-output name=connectionString::$(echo ${CONNECTION_STRING})

          echo ::add-mask::${INSTRUMENTATIONKEY}
          echo ::add-mask::${CONNECTION_STRING}
      - name: Set instrumentation key as secret
        uses: equinor/radix-github-actions@master
        with:
          args: >
            set environment-secret
            --context development
            -e ${{ steps.getEnvironment.outputs.result }}
            --component api
            -s APPINSIGHTS_INSTRUMENTATIONKEY
            -v '${{ steps.getSecrets.outputs.instrumentationKey }}'
      - name: Set connection string as secret
        uses: equinor/radix-github-actions@master
        with:
          args: >
            set environment-secret
            --context development
            -e ${{ steps.getEnvironment.outputs.result }}
            --component api
            -s AZURE_STORAGE_CONNECTION_STRING
            -v '${{ steps.getSecrets.outputs.connectionString }}'
